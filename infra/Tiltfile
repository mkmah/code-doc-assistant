# Tiltfile for Code Documentation Assistant local development
#
# Tilt provides hot reload, orchestration, and log aggregation for local development.
# Install: https://tilt.dev/
# Run: tilt up

# Kubernetes settings
k8s_yaml(helm(
    './charts/chroma',
    name='chroma',
    namespace='dev',
    values='./charts/chroma/values-dev.yaml',
))

# Local services
# These services run locally and are forwarded to k8s

# Backend service
local('cd ../backend && uv run uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload',
      name='backend',
      env_vars={
          'ANTHROPIC_API_KEY': os.getenv('ANTHROPIC_API_KEY', ''),
          'JINA_API_KEY': os.getenv('JINA_API_KEY', ''),
          'OPENAI_API_KEY': os.getenv('OPENAI_API_KEY', ''),
          'CHROMADB_HOST': 'localhost',
          'CHROMADB_PORT': '8000',
          'TEMPORAL_HOST': 'localhost',
          'TEMPORAL_PORT': '7233',
          'LOG_LEVEL': 'debug',
          'ENABLE_TRACING': 'true',
      },
)

# Temporal worker
local('cd ../temporal && uv run python worker.py',
      name='temporal-worker',
      env_vars={
          'ANTHROPIC_API_KEY': os.getenv('ANTHROPIC_API_KEY', ''),
          'JINA_API_KEY': os.getenv('JINA_API_KEY', ''),
          'CHROMADB_HOST': 'localhost',
          'CHROMADB_PORT': '8000',
      },
      deps=['../backend/app'],
)

# Docker Compose services (ChromaDB, Temporal, PostgreSQL)
dc_yaml='docker/docker-compose.yml'
docker_compose(dc_yaml)

# Port forwards
k8s_resource('chroma', port_forwards=8000,
             resource_newness='replaced')

# Live update for backend
# When Python files change, restart the backend
local_resource('backend',
    cmd='cd ../backend && uv run uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload',
    deps=['../backend/app/**/*.py'],
    env_vars={
        'ANTHROPIC_API_KEY': os.getenv('ANTHROPIC_API_KEY', ''),
        'JINA_API_KEY': os.getenv('JINA_API_KEY', ''),
        'CHROMADB_HOST': 'localhost',
        'CHROMADB_PORT': '8000',
    },
)

# Health checks
allow_k8s_contexts('minikube', 'kind', 'docker-desktop')
