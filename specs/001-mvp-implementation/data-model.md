# Data Model: MVP Implementation - Code Documentation Assistant

**Feature**: 001-mvp-implementation
**Date**: 2026-01-15
**Purpose**: Entity definitions, relationships, and validation rules

---

## Overview

This document defines the core data entities for the Code Documentation Assistant MVP. All entities are stored in-memory or in ChromaDB (vector store) for MVP simplicity.

---

## Entity Definitions

### 1. Codebase

Represents a complete software project uploaded by a user.

#### Attributes

| Field | Type | Required | Description | Validation |
|-------|------|----------|-------------|------------|
| `id` | UUID | Yes | Unique identifier | Auto-generated |
| `name` | str | Yes | Human-readable name | 1-100 chars |
| `description` | str | No | Optional description | Max 500 chars |
| `source_type` | SourceType | Yes | Upload source | Enum: `ZIP`, `GITHUB_URL` |
| `source_url` | str | No | GitHub URL if applicable | Valid GitHub URL |
| `file_storage_path` | str | No | Local file path | Valid absolute path |
| `size_bytes` | int | Yes | File size in bytes | <= 100MB (104,857,600) |
| `status` | CodebaseStatus | Yes | Ingestion status | Enum: `QUEUED`, `PROCESSING`, `COMPLETED`, `FAILED` |
| `total_files` | int | No | Total files to process | >= 0 |
| `processed_files` | int | No | Files processed so far | <= total_files |
| `primary_language` | str | No | Main language (e.g., "python") | From supported list |
| `all_languages` | list[str] | No | All detected languages | From supported list |
| `workflow_id` | str | No | Temporal workflow ID | Valid UUID format |
| `secrets_detected` | int | No | Count of secrets found | >= 0 |
| `secrets_summary` | dict | No | Secret details by file/type | JSON serializable |
| `error_message` | str | No | Error if status=FAILED | Max 1000 chars |
| `created_at` | datetime | Yes | Upload timestamp | UTC timezone |
| `updated_at` | datetime | Yes | Last update timestamp | UTC timezone |
| `completed_at` | datetime | No | Completion timestamp | UTC timezone, set when status=COMPLETED |

#### State Transitions

```
QUEUED → PROCESSING → COMPLETED
                    → FAILED
```

#### Relationships

- `has_many` CodeChunk (via codebase_id)
- `has_many` QuerySession (via codebase_id)

---

### 2. CodeChunk

Represents a semantically meaningful unit of code extracted from a codebase.

#### Attributes

| Field | Type | Required | Description | Validation |
|-------|------|----------|-------------|------------|
| `id` | UUID | Yes | Unique identifier | Auto-generated |
| `codebase_id` | UUID | Yes | Parent codebase | Foreign key to Codebase |
| `file_path` | str | Yes | Source file path | Relative to repo root |
| `line_start` | int | Yes | Start line number | >= 1 |
| `line_end` | int | Yes | End line number | >= line_start |
| `content` | str | Yes | Code content | Max 100KB |
| `language` | str | Yes | Programming language | From supported list |
| `chunk_type` | ChunkType | Yes | Semantic type | Enum: `FUNCTION`, `CLASS`, `MODULE`, `STATEMENT` |
| `name` | str | No | Function/class name | For function/class chunks |
| `docstring` | str | No | Extracted docstring | If present |
| `dependencies` | list[str] | No | Imported symbols | For tracking relationships |
| `parent_class` | str | No | Parent class name | For nested methods |
| `complexity` | int | No | Cyclomatic complexity | >= 0 |
| `embedding` | list[float] | No | Vector embedding | Generated by embedding service |
| `metadata` | dict | No | Additional metadata | JSON serializable |

#### Storage

Stored in ChromaDB vector store with metadata filtering by `codebase_id`, `language`, `chunk_type`.

#### Relationships

- `belongs_to` Codebase (via codebase_id)

---

### 3. QuerySession

Represents a conversation between a user and the system about a specific codebase.

#### Attributes

| Field | Type | Required | Description | Validation |
|-------|------|----------|-------------|------------|
| `session_id` | UUID | Yes | Unique identifier | Auto-generated |
| `codebase_id` | UUID | Yes | Target codebase | Foreign key to Codebase |
| `created_at` | datetime | Yes | Session creation | UTC timezone |
| `last_active` | datetime | Yes | Last message timestamp | UTC timezone |
| `message_count` | int | Yes | Total messages | >= 0 |
| `context_chunks` | list[UUID] | No | Cached relevant chunks | Optional optimization |

#### Relationships

- `belongs_to` Codebase (via codebase_id)
- `has_many` QueryMessage (via session_id)

---

### 4. QueryMessage

Represents a single question or answer in a conversation.

#### Attributes

| Field | Type | Required | Description | Validation |
|-------|------|----------|-------------|------------|
| `message_id` | UUID | Yes | Unique identifier | Auto-generated |
| `session_id` | UUID | Yes | Parent session | Foreign key to QuerySession |
| `role` | MessageType | Yes | Message role | Enum: `USER`, `ASSISTANT` |
| `content` | str | Yes | Message text | Max 10KB |
| `timestamp` | datetime | Yes | Message timestamp | UTC timezone |
| `citations` | list[Source] | No | Source citations | For assistant messages |
| `retrieved_chunks` | list[UUID] | No | Chunk IDs used | For context tracking |
| `token_count` | int | No | Response token count | For assistant messages |

#### Relationships

- `belongs_to` QuerySession (via session_id)

---

### 5. Source

Represents a code citation with file location.

#### Attributes

| Field | Type | Required | Description | Validation |
|-------|------|----------|-------------|------------|
| `file_path` | str | Yes | Source file path | Relative to repo root |
| `line_start` | int | Yes | Start line number | >= 1 |
| `line_end` | int | Yes | End line number | >= line_start |
| `snippet` | str | No | Code preview | Max 200 chars |

---

## Enums

### SourceType

```python
class SourceType(str, Enum):
    ZIP = "zip"
    GITHUB_URL = "github_url"
```

### CodebaseStatus

```python
class CodebaseStatus(str, Enum):
    QUEUED = "queued"
    PROCESSING = "processing"
    COMPLETED = "completed"
    FAILED = "failed"
```

### ChunkType

```python
class ChunkType(str, Enum):
    FUNCTION = "function"
    CLASS = "class"
    MODULE = "module"
    STATEMENT = "statement"
```

### MessageType

```python
class MessageType(str, Enum):
    USER = "user"
    ASSISTANT = "assistant"
```

---

## Relationships

```
Codebase (1) ───< (N) CodeChunk
    │
    └──< (N) QuerySession ───< (N) QueryMessage
                        │
                        └──> (N) Source (citations)
```

---

## Validation Rules

### Codebase Validation

1. **File size**: Must be <= 100MB (104,857,600 bytes)
2. **File type**: Must be `.zip` or `.tar.gz` for ZIP uploads
3. **GitHub URL**: Must match pattern `https://github.com/*/blob/*` or `https://github.com/*/tree/*`
4. **Name**: 1-100 characters, no special chars except `-_`
5. **Status transitions**: Only `QUEUED → PROCESSING → (COMPLETED | FAILED)`

### CodeChunk Validation

1. **Line numbers**: `line_end >= line_start`
2. **Content size**: Max 100KB per chunk
3. **Language**: Must be from supported list (python, javascript, typescript, java, go, rust)
4. **Chunk type**: Must be valid enum value
5. **Embedding**: Must be list of floats (dimension matches embedding model)

### QuerySession Validation

1. **Timeout**: Sessions expire after `session_timeout_seconds` of inactivity
2. **Codebase**: Must reference valid codebase_id
3. **Message count**: Must be >= 0

### QueryMessage Validation

1. **Content size**: Max 10KB per message
2. **Role**: Must be USER or ASSISTANT
3. **Session**: Must reference valid session_id
4. **Citations**: Only valid for ASSISTANT messages
5. **Token count**: Only set for ASSISTANT messages

---

## Storage Strategy

### In-Memory Stores (MVP)

- **CodebaseStore**: In-memory dict `codebase_id → Codebase`
- **SessionStore**: In-memory dict `session_id → QuerySession` + `session_id → list[QueryMessage]`

### Vector Store (ChromaDB)

- **Collection name**: `code_chunks`
- **Metadata filtering**: `codebase_id`, `language`, `chunk_type`
- **Embedding dimension**: 1024 (Jina v4) or 1536 (OpenAI)

### File Storage (Local Filesystem)

- **Base path**: Configurable via `file_storage_path` setting
- **File naming**: `{codebase_id}` (no extension, original stored in metadata)
- **Cleanup**: Delete file on codebase deletion

---

## Migration Notes

Future production migrations may require:

1. **Persistent CodebaseStore**: Replace in-memory with PostgreSQL
2. **Distributed SessionStore**: Replace with Redis for multi-instance deployments
3. **S3 Storage**: Replace local filesystem with S3 for scalability
4. **Pinecone**: Consider for vector store at scale (millions of chunks)

---

**Generated**: 2026-01-15 | **Phase**: 1 (Design) | **Status**: Complete
